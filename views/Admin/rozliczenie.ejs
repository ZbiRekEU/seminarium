<%- contentFor('HeaderCss') %>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
        integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

    <%- contentFor('breadcrumb') %>

        <%- contentFor('body') %>

            <div class="row">
                <div class="col-sm-12">
                    <div class="page-title-box">

                        <h4 class="page-title">Rozliczenia</h4>
                    </div>
                </div>
            </div>

            <div class="card mb-1 px-4 py-1 d-flex flex-row noprint">
                <button class="btn btn-success" onclick="exportToExcel()" id="xlsx"> <i
                        class="bi bi-file-earmark-arrow-down-fill mr-1"></i> Pobierz rozliczenia</button>
                <button class="btn btn-success ml-2" id="drukuj"><i class="bi bi-printer-fill mr-1 p-0"></i> Wydrukuj
                    rozliczenia</button>
            </div>

            <% settles.forEach((company, index1)=> { %>
                <div class="card mb-5 p-4">
                    <!-- <button onclick="exportToExcel('<%= index1 %>','<%= company[0].short_name%>' )">Pobierz rozliczenie</button>
    <button id="drukuj">Wydrukuj rozliczenie</button> -->
                    <table id="table<%=index1%>" class="table">
                        <tr>
                            <td colspan="9" style="text-align: center;">
                                <h4><strong>
                                        <% const currentDate=new Date(); const
                                            date=currentDate.toLocaleDateString("pl-PL", { day: "2-digit" ,
                                            month: "2-digit" , year: "numeric" });%>
                                            Rozliczenie <%= company[0].short_name%>
                                                <%= date%>
                                    </strong></h4>
                            </td>
                        </tr>
                        <tr>
                            <th id="Lp">Lp.</th>
                            <th id="Data">Data</th>
                            <th id="Odbiorca">Odbiorca</th>
                            <th id="Adres">Adres</th>
                            <th id="Produkt">Produkt</th>
                            <th id="Ilosc">Ilość paczek</th>
                            <th id="Pobranie">Pobranie</th>
                            <th id="Cena">Cena netto</th>
                            <th id="Wniesienie">Wniesienie</th>
                        </tr>
                        <% company.forEach((order, index2)=>{ %>
                            <tr>
                                <td>
                                    <%= index2+1 %>.
                                </td>
                                <td>
                                    <%= order.date.slice(8,10)%>.<%= order.date.slice(5,7)%>.<%= order.date.slice(0,4)%>
                                </td>
                                <td>
                                    <%= order.customer_name %>
                                </td>
                                <td>
                                    <%= order.postal_code %>
                                        <%= order.city %>, <%= order.street %>
                                                <%= order.house_number %>
                                                    <% if (order.apartment_number !='' ) { %> / <%=
                                                            order.apartment_number %>
                                                            <% } %>
                                </td>
                                <td>
                                    <%= order.product_name %>
                                </td>
                                <td>
                                    <%= order.package_number %>
                                </td>
                                <td>
                                    <%= order.price %> zł
                                </td>
                                <td><input class="inputCena<%= index1 %> inputsCena"
                                        oninput="{calcSum('<%=index1%>'); document.getElementById('fakeInput<%= index1 %><%=index2%>').innerHTML=this.value}"
                                        type="text" name="cena_netto" />
                                    <p style="display: none;" class="fakeInputsCena"
                                        id="fakeInput<%= index1 %><%=index2%>">0</p>
                                </td>


                                <% switch(order.bringing){ case '0' : %>
                                    <td>Nie</td>
                                    <% break; case '1' : %>
                                        <td>Tak</td>
                                        <% break; default: %>
                                            <td>BD</td>
                                            <% break; } %>
                            </tr>

                            <% }) %>
                                <tr>
                                    <td style="border: none;"></td>
                                    <td style="border: none;"></td>
                                    <td style="border: none;"></td>
                                    <td style="border: none;"></td>
                                    <td style="border: none;"></td>
                                    <td style="border: none;"></td>
                                    <td id="pobranie<%= index1 %>"></td>
                                    <td id="cena<%= index1 %>"></td>
                                    <td style="border: none;"></td>
                                </tr>
                    </table>
                    <div class="podpisContainer">
                        <p class="dots">......................................</p>
                        <p class="podpis">Podpis</p>
                    </div>
                    
                    <%if(index1+1 !== settles?.length){%>
                        <div class="newpage"></div>
                    <%}%> 
                    
                       

                </div>
                <% }) %>



                    <%- contentFor('FooterJs') %>
                        <%- contentFor('BottomJs') %>

                            <style>
                                .podpisContainer {
                                    margin-left: auto;
                                    align-items: center;
                                    justify-content: center;
                                    margin-top: 50px;
                                }

                                .dots,
                                .podpis {
                                    margin: 0 150px;
                                    text-align: center;
                                }

                                .dots {
                                    font: 20px;
                                }
                            </style>

                            <!-- obliczenie sumy pieniędzy za płatności przy odbiorze -->
                            <!-- obliczenie sumy wprowadzonych w inputach cen -->
                            <script>
                                $(document).ready(function () {
                                    
                                    let settles = '<%- JSON.stringify(settles) %>';
                                    let parsedSettles = JSON.parse(settles);


                                    parsedSettles.forEach((settle, index) => {
                                        var sum = 0
                                        settle.forEach(order => {
                                            sum += order.price
                                        })
                                        document.getElementById(`pobranie${index}`).innerText = `${sum} zł`

                                    });

                                })


                                function calcSum(i) {
                                    let inputs = document.getElementsByClassName(`inputCena${i}`)
                                    var sum = 0
                                    Array.from(inputs).forEach(input => {
                                        let parsedInput = input.value.replace(/,/g, ".");
                                        input.value = parsedInput
                                        sum += Number(parsedInput)
                                    })
                                    document.getElementById(`cena${i}`).innerText = `${sum} zł`
                                }
                            </script>

                            <!-- Eksport od xlsx i automatyczne pobieranie -->
                            <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.15.6/xlsx.full.min.js"></script>
                            <script>
                                function exportToExcel() {
                                    let settles = '<%- JSON.stringify(settles) %>';
                                    let parsedSettles = JSON.parse(settles);

                                    const currentDate = new Date();
                                    const date = currentDate.toLocaleDateString("pl-PL", {
                                        day: "2-digit",
                                        month: "2-digit",
                                        year: "numeric"
                                    });

                                    parsedSettles.forEach((settle, index) => {
                                        let name = settle[0].short_name;
                                        var wb = XLSX.utils.table_to_book(document.getElementById(`table${index}`));
                                        var wbout = XLSX.write(wb, { bookType: 'xlsx', bookSST: true, type: 'binary' });
                                        var blob = new Blob([s2ab(wbout)], { type: "application/octet-stream" });
                                        var link = document.createElement('a');
                                        link.href = window.URL.createObjectURL(blob);
                                        link.download = `${name}_rozliczenie_${date}.xlsx`;
                                        link.click();
                                    })

                                    markAsSettled()

                                }
                                function s2ab(s) {
                                    var buf = new ArrayBuffer(s.length);
                                    var view = new Uint8Array(buf);
                                    for (var i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
                                    return buf;
                                }

                            </script>

                            <!-- Drukowanie tabeli -->
                            <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.4/jspdf.min.js"></script>
                            <script>
                                $(document).ready(async () => {

                                    $("#drukuj").on('click', async () => {

                                        var inputsCena = document.getElementsByClassName("inputsCena");
                                        var fakeInputsCena = document.getElementsByClassName("fakeInputsCena");
                                        for (let i = 0; i < inputsCena.length; i++) {
                                            inputsCena[i].style.display = "none";
                                            fakeInputsCena[i].style.display = "block";
                                        }
                                       
                                        window.print();

                                        for (let i = 0; i < inputsCena.length; i++) {
                                            inputsCena[i].style.display = "block";
                                            fakeInputsCena[i].style.display = "none";
                                        }
                                        markAsSettled()
                                    })

                                })
                            </script>

                            <!-- Oznaczenie zamówień jako rozliczone -->
                            <script>

                                async function markAsSettled() {
                                    //przygotowanie id wszystkich zamowien
                                    let settles = '<%- JSON.stringify(settles) %>';
                                    let parsedSettles = JSON.parse(settles);
                                    console.log("Parsed:", parsedSettles);
                                    var idArray = []
                                    parsedSettles.forEach(settles => {
                                        settles.forEach(settle => {
                                            idArray.push(settle.order_id)
                                        })
                                    })

                                    //wysłanie żądania o oznaczenie jako rozliczone
                                    const response = await fetch("/markassettled", {
                                        method: 'POST',
                                        headers: {
                                            'Accept': 'application/json',
                                            'Content-Type': 'application/json'
                                        },
                                        body: `{
                                                "Id": ${JSON.stringify(idArray)}
                                                }`,
                                    });

                                    response.json().then(data => {
                                        console.log(data);
                                    });

                                }

                            </script>


                            <style>
                                @media print {
                                    .noprint{
                                        display: none !important;
                                    }
                                    .table {
                                        border-collapse: collapse;
                                       
                                    }
                                    .newpage{
                                        page-break-before: always;
                                    }

                                    .table th,
                                    .table td {
                                        border: 1px solid #000;
                                        padding: 0.5rem;
                                    }
                                    .card{
                                        border: none;
                                    }
                                    .podpisContainer{
                                        margin-top: 100px;
                                    }
                                    .dots{
                                        font-size: 20px
                                    }
                                    .podpis{
                                        font-size: 20px
                                    }
                                }
                          

                                @import url("https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css");

                                table {
                                    padding: 0 10px !important;
                                }

                                table th,
                                table td {
                                    width: max-content;
                                    margin: 0 0px;
                                    padding: 0px;
                                    border: 1px solid lightgray;
                                    font-size: 16px;
                                }
                            </style>